#!/bin/bash

cd /tmp

if [ -d /tmp/ccache ]; then

tg () {
	curl -s "https://api.telegram.org/bot${bot_api}/sendmessage" --data "text=$1&chat_id=${chat_id}"
}

up () {
 if [ -e $1 ]; then
  echo "uploading $1"
	curl --retry 18 --upload-file $1 temp.sh
	 #3d, 4000mb limit
  fi
}

# Compress function with pigz for faster compression
com ()
{
    tar --use-compress-program="pigz -k -$2 " -cf $1.tar.gz $1
}

# disable ccache upload if rom compilation was successful
if [ ! -e rom/out/target/product/*/*2022*zip ]; then
if [ -d /tmp/ccache ]; then
echo "|| Compressing CCACHE ||"

# First compress in with pigz in a single zip.
time com ccache 1 # Compression level 1, its enough

# Now split into 2GB parts (if user selects temp.sh upload)
if [ $1 == temp ]; then
	7za a -tzip -v2048m -mx=0 $2_ccache_backup.zip ccache.tar.gz
	# upload all parts
	echo "|| Uploading CCACHE ||"
	for i in /tmp/$2_ccache_backup.zip.*; do
	   send_zip=$(up $i) && tg "CCACHE Uploaded!
$send_zip"
	done
# Use normal full size ccache & upload on sfg
elif [ $1 == sfg ]; then
	7za a -tzip -mx=0 $2_ccache_backup.zip ccache.tar.gz
	echo "|| Uploading CCACHE ||"
	send_zip=$(sfg_up ccache.tar.gz) && tg "CCACHE Uploaded!
$send_zip"
fi

sleep 5
echo "|| Uploaded ||"
fi
fi

echo "|| Clean storage ||"
rm -rf /tmp/rom
echo "|| Done ||"
